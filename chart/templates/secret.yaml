{{- if eq .Values.secretType "secret" }}
apiVersion: v1
kind: Secret
{{- else if eq .Values.secretType "sealedSecret" }}
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
{{- end }}
metadata:
  name: {{ include "joy-generator.fullname" . }}-config
{{- if eq .Values.secretType "secret" }}
stringData:
  JOY_PLUGIN_TOKEN: "{{ required "pluginToken is required" .Values.applicationConfig.pluginToken }}"
  JOY_REPO_URL: "{{ required "repoUrl is required" .Values.applicationConfig.repoUrl }}"
  {{- if .Values.applicationConfig.githubApp }}
  JOY_GITHUB_APP_ID: "{{ .Values.applicationConfig.githubApp.appId }}"
  JOY_GITHUB_APP_INSTALLATION_ID: "{{ .Values.applicationConfig.githubApp.installationId }}"
  {{- else if .Values.applicationConfig.githubToken }}
  JOY_GITHUB_TOKEN: "{{ .Values.applicationConfig.githubToken }}"
  {{- else }}
  {{- fail "either a github token or github app is required" }}
  {{- end }}
{{- else if eq .Values.secretType "sealedSecret" }}
spec:
  encryptedData:
    JOY_PLUGIN_TOKEN: "{{ required "pluginToken is required" .Values.applicationConfig.pluginToken }}"
    JOY_REPO_URL: "{{ required "repoUrl is required" .Values.applicationConfig.repoUrl }}"
    {{- if .Values.applicationConfig.githubApp }}
    JOY_GITHUB_APP_ID: "{{ .Values.applicationConfig.githubApp.appId }}"
    JOY_GITHUB_APP_INSTALLATION_ID: "{{ .Values.applicationConfig.githubApp.installationId }}"
    {{- else if .Values.applicationConfig.githubToken }}
    JOY_GITHUB_TOKEN: "{{ .Values.applicationConfig.githubToken }}"
    {{- else }}
    {{- fail "either a github token or github app is required" }}
    {{- end }}
{{- end }}

---
{{- if .Values.applicationConfig.githubApp }}
{{- if eq .Values.secretType "secret" }}
apiVersion: v1
kind: Secret
{{- else if eq .Values.secretType "sealedSecret" }}
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
{{- end }}
metadata:
  name: {{ include "joy-generator.fullname" . }}-github-app-key
{{- if eq .Values.secretType "secret" }}
stringData:
  githubApp.pem: |
{{ .Values.applicationConfig.githubApp.privateKey | indent 4 }}
{{- else if eq .Values.secretType "sealedSecret" }}
spec:
  encryptedData:
    githubApp.pem: |
{{ .Values.applicationConfig.githubApp.privateKey | indent 6 }}
{{- end }}
{{- end }}
